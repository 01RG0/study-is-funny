<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test QR Flow</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="js/database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 10px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .result { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #28a745; }
        .error { border-left-color: #dc3545; }
    </style>
</head>
<body>
    <h1>üß™ Test QR Code Generation Flow</h1>

    <div class="test-section">
        <h2>1Ô∏è‚É£ Simulate Student Login</h2>
        <button onclick="simulateLogin()">Login as 01280912038</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h2>2Ô∏è‚É£ Test Student Data Retrieval</h2>
        <button onclick="testStudentData()">Get Student Data</button>
        <div id="dataResult"></div>
    </div>

    <div class="test-section">
        <h2>3Ô∏è‚É£ Test QR Code Generation</h2>
        <button onclick="testQRGeneration()">Generate QR Codes</button>
        <div id="qrResult"></div>
    </div>

    <div class="test-section">
        <h2>4Ô∏è‚É£ Open Grade Page</h2>
        <button onclick="openGradePage()">Go to Grade Page</button>
        <p><small>This should show QR codes if everything works</small></p>
    </div>

    <script>
        async function simulateLogin() {
            const resultDiv = document.getElementById('loginResult');
            const phone = '01280912038';

            try {
                // Simulate login by setting localStorage
                localStorage.setItem('accessGranted', 'true');
                localStorage.setItem('userPhone', phone);

                resultDiv.innerHTML = `
                    <div class="result">
                        ‚úÖ Login simulated successfully<br>
                        Phone: ${phone}<br>
                        localStorage updated
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Login failed: ${error.message}</div>`;
            }
        }

        async function testStudentData() {
            const resultDiv = document.getElementById('dataResult');
            const phone = localStorage.getItem('userPhone');

            if (!phone) {
                resultDiv.innerHTML = '<div class="result error">‚ùå No phone number in localStorage. Please login first.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="result">üîÑ Loading student data...</div>';

            try {
                const studentData = await getStudentData(phone);

                if (studentData) {
                    resultDiv.innerHTML = `
                        <div class="result">
                            ‚úÖ Student data retrieved successfully<br>
                            Name: ${studentData.name}<br>
                            Phone: ${studentData.phone}<br>
                            Grade: ${studentData.grade}<br>
                            Subjects: ${studentData.subjects ? studentData.subjects.join(', ') : 'None'}<br>
                            Active: ${studentData.isActive ? 'Yes' : 'No'}
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="result error">‚ùå No student data found</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error getting student data: ${error.message}</div>`;
                console.error('Student data error:', error);
            }
        }

        async function testQRGeneration() {
            const resultDiv = document.getElementById('qrResult');
            const phone = localStorage.getItem('userPhone');

            if (!phone) {
                resultDiv.innerHTML = '<div class="result error">‚ùå No phone number in localStorage. Please login first.</div>';
                return;
            }

            resultDiv.innerHTML = '<div class="result">üîÑ Generating QR codes...</div>';

            try {
                const studentData = await getStudentData(phone);

                if (studentData && studentData.subjects && studentData.subjects.length > 0) {
                    let html = '<div class="result">‚úÖ QR codes generated successfully:</div>';

                    studentData.subjects.forEach(subject => {
                        const subjectName = getSubjectName(subject);
                        const qrData = JSON.stringify({
                            studentPhone: studentData.phone,
                            subject: subject,
                            grade: studentData.grade,
                            timestamp: Date.now(),
                            accessToken: generateAccessToken(studentData.phone, subject)
                        });

                        const accessUrl = `${window.location.origin}/senior${studentData.grade === 'senior1' ? '1' : '2'}/${subject}/qr-access/?qr=${encodeURIComponent(qrData)}`;

                        html += `
                            <div style="display: inline-block; margin: 10px; text-align: center; background: white; padding: 10px; border-radius: 8px;">
                                <h4>${subjectName}</h4>
                                <canvas id="test-qr-${subject}" width="120" height="120"></canvas>
                                <small style="color: #666;">${subject}</small>
                            </div>
                        `;
                    });

                    resultDiv.innerHTML = html;

                    // Generate QR codes
                    studentData.subjects.forEach(subject => {
                        const qrData = JSON.stringify({
                            studentPhone: studentData.phone,
                            subject: subject,
                            grade: studentData.grade,
                            timestamp: Date.now(),
                            accessToken: generateAccessToken(studentData.phone, subject)
                        });

                        const accessUrl = `${window.location.origin}/senior${studentData.grade === 'senior1' ? '1' : '2'}/${subject}/qr-access/?qr=${encodeURIComponent(qrData)}`;

                        setTimeout(() => {
                            QRCode.toCanvas(document.getElementById(`test-qr-${subject}`), accessUrl, {
                                width: 120,
                                height: 120
                            });
                        }, 100);
                    });
                } else {
                    resultDiv.innerHTML = '<div class="result error">‚ùå No subjects found for QR generation</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">‚ùå Error generating QR codes: ${error.message}</div>`;
                console.error('QR generation error:', error);
            }
        }

        function getSubjectName(subject) {
            const names = {
                physics: 'ÿßŸÑŸÅŸäÿ≤Ÿäÿßÿ°',
                mathematics: 'ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿßÿ™',
                statistics: 'ÿßŸÑÿ•ÿ≠ÿµÿßÿ°'
            };
            return names[subject] || subject;
        }

        function generateAccessToken(phone, subject) {
            return btoa(`${phone}:${subject}:${Date.now()}`).substring(0, 16);
        }

        function openGradePage() {
            window.open('grade/index.html', '_blank');
        }

        // Auto-check login status
        document.addEventListener('DOMContentLoaded', function() {
            const phone = localStorage.getItem('userPhone');
            if (phone) {
                document.querySelector('h1').innerHTML += ` <small>(Logged in as: ${phone})</small>`;
            }
        });
    </script>
</body>
</html>